<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PosturEase - Dashboard</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo-test-2-1-10.png') }}">
  <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='images/logo-test-2-1-10.png') }}">
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/common.css') }}">
  <script src="{{ url_for('static', filename='js/darkMode.js') }}"></script>
  <!-- Professional Web Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Add TensorFlow.js and PoseNet for posture detection -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet@latest"></script>
  <style>
    /* Dashboard Specific Styles - Minimalist Approach */
    .dashboard-container {
      min-height: 100vh;
      background-color: #e8fefb;
      position: relative;
      overflow-x: hidden;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* Clean Header Styles */
    .header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-light);
      padding: var(--space-4) var(--space-6);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-2) var(--space-4);
      background: var(--surface-primary);
      border-radius: var(--radius-full);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-normal);
    }

    .user-profile:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-full);
      object-fit: cover;
      border: 2px solid var(--primary-blue);
    }

    .user-info {
      display: flex;
      flex-direction: column;
    }

    .user-name {
      font-size: var(--text-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      line-height: 1.2;
    }

    .user-status {
      font-size: var(--text-xs);
      color: var(--text-secondary);
    }

    .header-center {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-2);
    }

    .logo {
      width: 64px;
      height: 64px;
      border-radius: var(--radius-2xl);
      object-fit: cover;
      box-shadow: var(--shadow-lg);
      transition: all var(--transition-normal);
    }

    .logo:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-xl);
    }

    .logo-text {
      font-size: var(--text-xl);
      font-weight: var(--font-weight-bold);
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .menu-btn {
      width: 44px;
      height: 44px;
      background: var(--surface-primary);
      border: none;
      border-radius: var(--radius-xl);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-normal);
      box-shadow: var(--shadow-sm);
    }

    .menu-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .menu-icon {
      width: 20px;
      height: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 3px;
    }

    .menu-icon span {
      display: block;
      width: 100%;
      height: 2px;
      background: var(--text-primary);
      border-radius: var(--radius-sm);
      transition: all var(--transition-normal);
    }

    .menu-btn:hover .menu-icon span {
      background: var(--primary-blue);
    }

    /* Main Content */
    .main-content {
      padding: var(--space-6) var(--space-6) var(--space-4);
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
      z-index: 2;
      min-height: calc(100vh - 200px);
      display: flex;
      flex-direction: column;
      justify-content: center;
    }


    /* Camera Section */
    .camera-section {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: var(--space-8);
      margin-bottom: var(--space-12);
    }

    .camera-container {
      position: relative;
      background: var(--surface-primary);
      border-radius: var(--radius-3xl);
      padding: var(--space-6);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-light);
    }

    .camera-screen {
      width: 100%;
      height: 400px;
      background: var(--neutral-100);
      border-radius: var(--radius-2xl);
      overflow: hidden;
      position: relative;
      border: 2px solid var(--border-light);
    }

    .video-feed {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: var(--radius-2xl);
    }

    .camera-overlay {
      position: absolute;
      top: var(--space-4);
      left: var(--space-4);
      right: var(--space-4);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .status-badge {
      background: rgba(0, 0, 0, 0.8);
      color: var(--text-inverse);
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-full);
      font-size: var(--text-sm);
      font-weight: var(--font-weight-medium);
      backdrop-filter: blur(10px);
    }

    .confidence-indicator {
      background: rgba(0, 0, 0, 0.8);
      color: var(--text-inverse);
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-full);
      font-size: var(--text-sm);
      font-weight: var(--font-weight-medium);
      backdrop-filter: blur(10px);
    }

    .posture-status {
      position: absolute;
      bottom: var(--space-4);
      left: var(--space-4);
      right: var(--space-4);
      display: flex;
      justify-content: center;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-4) var(--space-6);
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--radius-full);
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-light);
      transition: all var(--transition-normal);
      cursor: pointer;
    }

    .status-indicator:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      background: rgba(255, 255, 255, 1);
    }

    .status-dot {
      width: 20px;
      height: 20px;
      border-radius: var(--radius-full);
      background: var(--neutral-300);
      transition: all var(--transition-normal);
      flex-shrink: 0;
      position: relative;
    }

    /* Only show colored dots when monitoring */
    .status-dot.monitoring {
      background: var(--neutral-300);
    }

    .status-dot.good {
      background: var(--success);
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
      animation: pulseGood 2s infinite;
    }

    .status-dot.warning {
      background: var(--warning);
      box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2);
      animation: pulseWarning 1s infinite;
    }

    .status-dot.bad {
      background: var(--error);
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2);
      animation: pulseBad 0.8s infinite;
    }

    .status-text {
      font-size: var(--text-base);
      font-weight: var(--font-weight-medium);
      color: var(--text-primary);
      white-space: nowrap;
      transition: color var(--transition-normal);
    }

    .status-indicator:hover .status-text {
      color: var(--primary-blue);
    }

    @keyframes pulseGood {
      0%, 100% { 
        opacity: 1; 
        transform: scale(1);
      }
      50% { 
        opacity: 0.8; 
        transform: scale(1.1);
      }
    }

    @keyframes pulseWarning {
      0%, 100% { 
        opacity: 1; 
        transform: scale(1);
      }
      50% { 
        opacity: 0.7; 
        transform: scale(1.15);
      }
    }

    @keyframes pulseBad {
      0%, 100% { 
        opacity: 1; 
        transform: scale(1);
      }
      50% { 
        opacity: 0.6; 
        transform: scale(1.2);
      }
    }

    /* Controls Section */
    .controls-section {
      display: flex;
      flex-direction: column;
      gap: var(--space-6);
    }

    .posture-status-panel {
      background: var(--surface-primary);
      padding: var(--space-4);
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-light);
      margin-bottom: var(--space-4);
    }

    .control-buttons {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .btn-monitor {
      padding: var(--space-4) var(--space-6);
      font-size: var(--text-base);
      font-weight: var(--font-weight-medium);
      border-radius: var(--radius-xl);
      transition: all var(--transition-normal);
      border: none;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .btn-monitor::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.6s;
    }

    .btn-monitor:hover::before {
      left: 100%;
    }

    .btn-start {
      background: var(--primary-green);
      color: var(--text-inverse);
      box-shadow: var(--shadow-sm);
    }

    .btn-start:hover {
      background: #00B894;
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .btn-start:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    .btn-stop {
      background: var(--error);
      color: var(--text-inverse);
      box-shadow: var(--shadow-sm);
    }

    .btn-stop:hover {
      background: #DC2626;
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .btn-stop:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    /* Stats Section */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
      margin-top: var(--space-6);
    }

    .stat-card {
      background: var(--surface-primary);
      padding: var(--space-6);
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-light);
      transition: all var(--transition-normal);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(0, 102, 255, 0.05) 0%, rgba(0, 212, 170, 0.05) 100%);
      opacity: 0;
      transition: opacity var(--transition-normal);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-blue);
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-card:active {
      transform: translateY(-2px);
    }

    .stat-value {
      font-size: var(--text-3xl);
      font-weight: var(--font-weight-bold);
      color: var(--primary-blue);
      margin-bottom: var(--space-2);
    }

    .stat-label {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      font-weight: var(--font-weight-medium);
    }

    /* Side Menu */
    .side-menu {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100vh;
      background-color: var(--card-background);
      box-shadow: -2px 0 10px var(--shadow-color);
      transition: all 0.3s ease-in-out;
      z-index: 1000;
      padding: 20px;
      visibility: hidden;
      opacity: 0;
    }

    .side-menu.active {
      right: 0;
      visibility: visible;
      opacity: 1;
    }

    .menu-header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 12px;
      margin-bottom: 30px;
      padding: 0 15px;
      position: relative;
    }

    .menu-logo {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .menu-logo img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      aspect-ratio: 1/1;
      overflow: hidden;
    }

    .menu-logo-text {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-color);
    }

    .menu-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-color);
    }

    .menu-items {
      display: flex;
      flex-direction: column;
      gap: 8px;
      list-style: none;
      padding: 0;
      margin: 20px 0;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px;
      border-radius: 8px;
      text-decoration: none;
      color: var(--text-color);
      transition: all 0.3s ease;
    }

    .menu-item:hover {
      background: var(--neutral-100);
      transform: translateX(4px);
    }

    .menu-item.active {
      background: var(--primary-blue);
      color: var(--text-inverse);
    }

    .menu-item.active i {
      color: var(--text-inverse);
    }

    .menu-item i {
      font-size: 20px;
      width: 24px;
      text-align: center;
      color: var(--primary-color);
      transition: transform 0.3s ease;
    }

    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: var(--z-modal-backdrop);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-normal);
    }

    .menu-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* Mobile-First Responsive Design */
    @media (max-width: 1024px) {
      .camera-section {
        grid-template-columns: 1fr;
        gap: var(--space-6);
      }
      
      .controls-section {
        order: -1;
      }
    }

    @media (max-width: 768px) {
      .header {
        padding: var(--space-3) var(--space-4);
        flex-wrap: wrap;
        gap: var(--space-2);
      }
      
      .header-center {
        position: static;
        transform: none;
        order: -1;
        width: 100%;
        margin-bottom: var(--space-2);
      }
      
      .header-left, .header-right {
        flex: 1;
      }
      
      .user-profile {
        padding: var(--space-2) var(--space-3);
      }
      
      .user-info {
        display: none; /* Hide on mobile to save space */
      }
      
      .main-content {
        padding: var(--space-6) var(--space-4);
      }
      
      .welcome-title {
        font-size: var(--text-2xl);
      }
      
      .welcome-subtitle {
        font-size: var(--text-sm);
      }
      
      .camera-screen {
        height: 250px;
      }
      
      .camera-container {
        padding: var(--space-4);
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-3);
      }
      
      .stat-card {
        padding: var(--space-4);
      }
      
      .stat-value {
        font-size: var(--text-2xl);
      }
      
      .btn-monitor {
        padding: var(--space-3) var(--space-4);
        font-size: var(--text-sm);
      }
      
      .status-indicator {
        padding: var(--space-2) var(--space-3);
        font-size: var(--text-xs);
      }
      
      .status-text {
        font-size: var(--text-xs);
      }
    }

    @media (max-width: 480px) {
      .header {
        padding: var(--space-2) var(--space-3);
      }
      
      .main-content {
        padding: var(--space-4) var(--space-3);
      }
      
      .welcome-title {
        font-size: var(--text-xl);
      }
      
      .camera-screen {
        height: 200px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
        gap: var(--space-2);
      }
      
      .control-buttons {
        gap: var(--space-3);
      }
      
      .btn-monitor {
        padding: var(--space-4);
        font-size: var(--text-base);
      }
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      position: relative;
    }

    .welcome-container {
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 2;
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 16px;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .welcome-container:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
    }

    .account-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .welcome-container:hover .account-circle {
      transform: scale(1.05);
    }

    .account-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .welcome-text {
      display: flex;
      flex-direction: column;
    }

    .welcome {
      font-weight: 400;
      font-size: 13px;
      color: var(--text-color);
      opacity: 0.8;
    }

    .user-name {
      font-weight: 600;
      font-size: 15px;
      color: var(--text-color);
      letter-spacing: -0.2px;
    }

    .center-logo-container {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 1;
      transition: all 0.3s ease;
    }

    .logo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      aspect-ratio: 1/1;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .center-logo-container:hover .logo {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }

    .logo-text {
      margin-top: 6px;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-color);
      letter-spacing: -0.2px;
    }

    .menu {
      width: 40px;
      height: 40px;
      cursor: pointer;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      padding: 0;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .menu:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
    }

    .menu-icon {
      width: 24px;
      height: 24px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 5px;
    }

    .menu-icon span {
      display: block;
      width: 100%;
      height: 2px;
      background-color: var(--text-primary);
      border-radius: 2px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .menu:hover .menu-icon span {
      background-color: var(--primary-color);
    }

    .menu-icon.active span:nth-child(1) {
      transform: translateY(8px) rotate(45deg);
    }

    .menu-icon.active span:nth-child(2) {
      opacity: 0;
    }

    .menu-icon.active span:nth-child(3) {
      transform: translateY(-8px) rotate(-45deg);
    }

    .background-images {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: 0;
    }

    .background-images img {
      position: absolute;
      width: 100%;
      height: auto;
      object-fit: cover;
    }

    .camera-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 40px;
      position: relative;
      padding: 0 20px;
    }

    .camera-screen {
      width: 800px;
      max-width: 100%;
      height: 500px;
      background-color: var(--card-background);
      border-radius: 42px;
      box-shadow: 0px 20px 50px 0px var(--shadow-color), 
                  inset 0px 0px 0px 1.5px var(--border-color);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
      transition: all 0.3s ease;
    }

    .video-container {
      width: 100%;
      height: 100%;
      position: relative;
      transform: scaleX(-1); /* Mirror only the video container */
    }

    .video-feed {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 42px;
      transform: scaleX(-1); /* Mirror the video feed */
    }

    .status-overlay {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px 20px;
      border-radius: 20px;
      color: white;
      font-weight: 500;
      font-size: 14px;
      z-index: 10;
    }

    .posture-status-indicator {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 10;
    }


    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    


    .controls-container {
      display: flex;
      gap: 20px;
      margin-top: 30px;
    }

    .control-button {
      background: var(--card-background);
      border: none;
      padding: 12px 24px;
      border-radius: 15px;
      font-family: var(--font-family-sf);
      font-weight: 500;
      font-size: 14px;
      color: var(--text-color);
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0px 8px 20px var(--shadow-color);
    }

    .control-button:hover {
      transform: translateY(-2px);
      box-shadow: 0px 12px 25px var(--shadow-color);
    }

    .start-button {
      background: var(--success-color);
      color: white;
    }

    .stop-button {
      background: var(--danger-color);
      color: white;
    }

    .canvas-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 42px;
      pointer-events: none;
    }

    .monitoring-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 30px;
      gap: 20px;
    }

    .monitoring-button {
      background: linear-gradient(135deg, var(--primary-color) 0%, #00b894 100%);
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 20px rgba(0, 212, 170, 0.3);
      min-width: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .monitoring-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 25px rgba(0, 212, 170, 0.4);
    }

    .monitoring-button:active {
      transform: translateY(0);
    }

    .monitoring-button.monitoring {
      background: linear-gradient(135deg, var(--danger-color) 0%, #d63031 100%);
      box-shadow: 0 8px 20px rgba(255, 59, 48, 0.3);
    }

    .monitoring-button.monitoring:hover {
      box-shadow: 0 12px 25px rgba(255, 59, 48, 0.4);
    }

    .posture-status {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 24px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      min-width: 250px;
      justify-content: center;
    }


    .status-text {
      font-weight: 500;
      font-size: 14px;
      color: var(--text-color);
    }

    /* Ensure posture indicator text is visible on dark background */
    .posture-status-indicator .status-text {
      color: #ffffff;
    }

    /* Confidence level indicator styles */
    .confidence-level-indicator {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .confidence-label {
      opacity: 0.8;
      margin-right: 6px;
    }

    .confidence-value {
      font-weight: 600;
      color: #34c759;
    }

    .monitoring-stats {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.9);
      padding: 16px 20px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      text-align: center;
      min-width: 120px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-color);
      opacity: 0.7;
    }

    /* Side Menu Styles */
    .side-menu {
      position: fixed;
      top: 0;
      right: -100%;
      width: 300px;
      height: 100vh;
      background: rgb(255, 255, 255);
      backdrop-filter: blur(10px);
      box-shadow: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      padding: 20px;
      visibility: hidden;
      opacity: 0;
      transform: translateX(30px);
    }

    .side-menu.active {
      right: 0;
      visibility: visible;
      opacity: 1;
      transform: translateX(0);
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
    }

    .menu-items {
      list-style: none;
      padding: 0;
      margin: 20px 0;
    }

    .menu-item {
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
      color: var(--text-color);


      text-decoration: none;
      border-radius: 8px;
      margin: 5px 0;
      transition: all 0.3s ease;
    }

    .menu-item:hover {
      background: rgba(0, 122, 255, 0.1);
      transform: translateX(5px);
    }

    .menu-item.active {
      background: rgba(0, 122, 255, 0.15);
      font-weight: 500;
    }

    .menu-item i {
      font-size: 20px;
      width: 24px;
      text-align: center;
      color: var(--primary-color);
      transition: transform 0.3s ease;
    }

    .menu-item:hover i {
      transform: scale(1.1);
    }

    .menu-close {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-color);
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .menu-close:hover {
      transform: translateY(-50%) rotate(90deg);
      color: var(--primary-color);
    }

    .menu-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 30px;
      padding: 0 15px;
      position: relative;
    }

    .menu-logo-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .menu-header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .menu-header-text {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-color);
    }

    .logout-item {
      color: #ff3b30 !important;
    }

    /* Responsive styles */
    @media (max-width: 768px) {
      .side-menu {
        width: 100%;
      }

      .menu-header {
        margin-top: 20px;
      }

      .camera-screen {
        height: 400px;
        border-radius: 30px;
      }

      img {
        border-radius: 30px;
      }

      .canvas-overlay {
        border-radius: 30px;
      }

      .welcome-container {
        padding: 6px 12px;
      }

      .account-circle {
        width: 32px;
        height: 32px;
      }

      .welcome {
        font-size: 12px;
      }

      .user-name {
        font-size: 14px;
      }

      .monitoring-stats {
        flex-direction: column;
        align-items: center;
      }

      .monitoring-button {
        min-width: 180px;
        font-size: 14px;
      }
    }

    /* Overlay */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease-in-out;
      z-index: -1;
    }

    .overlay.active {
      opacity: 1;
      visibility: visible;
      z-index: 999;
    }

    /* Add overlay for menu background */
    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 999;
      pointer-events: none;
    }

    .menu-overlay.active {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
  </style>
  <!-- Add Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <div class="dashboard-container">
    <!-- Modern Header -->
    <header class="header">
      <div class="header-left">
        <div class="user-profile">
          <img id="dashboard-profile-picture" src="{{ url_for('static', filename='images/icon-5.svg') }}" alt="Profile" class="user-avatar">
          <div class="user-info">
            <div class="user-name" id="dashboard-user-name">User</div>
            <div class="user-status">Ready to monitor</div>
  </div>
      </div>
    </div>
    
      <div class="header-center">
      <img src="{{ url_for('static', filename='images/logo-test-2-1-10.png') }}" alt="PosturEase" class="logo">
        <div class="logo-text">PosturEase</div>
    </div>
    
      <div class="header-right">
        <button class="menu-btn" onclick="toggleMenu()">
      <div class="menu-icon">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </button>
  </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Camera Section -->
      <section class="camera-section">
  <div class="camera-container">
    <div class="camera-screen">
      <img src="{{ url_for('video_feed') }}" class="video-feed" alt="Posture Detection Feed">
            
            <div class="camera-overlay">
              <div class="status-badge" id="statusBadge">PosturEase Active</div>
              <div class="confidence-indicator" id="confidenceIndicator">Confidence: 0%</div>
            </div>
          </div>
      </div>
      
        <!-- Controls Section -->
        <div class="controls-section">
          <!-- Posture Status Side Panel -->
          <div class="posture-status-panel">
            <div class="status-indicator">
              <span class="status-text" id="statusText">Ready to monitor</span>
            </div>
          </div>
          
          <div class="control-buttons">
            <button class="btn-monitor btn-start" onclick="startMonitoring()">
              <i class="fas fa-play"></i>
              Start Monitoring
            </button>
            <button class="btn-monitor btn-stop" onclick="stopMonitoring()">
              <i class="fas fa-stop"></i>
              Stop Monitoring
            </button>
          </div>

          <!-- Stats Grid -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="sessionTime">0s</div>
              <div class="stat-label">Session Time</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="goodPostureTime">0s</div>
              <div class="stat-label">Good Posture</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="warningsCount">0</div>
              <div class="stat-label">Warnings</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="correctionsCount">0</div>
              <div class="stat-label">Corrections</div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Menu Overlay -->
    <div class="menu-overlay" id="menuOverlay"></div>
    
    <!-- Side Menu -->
    <div class="side-menu" id="sideMenu">
      <div class="menu-header">
        <div class="menu-logo">
          <img src="{{ url_for('static', filename='images/logo-test-2-1-10.png') }}" alt="PosturEase">
          <span class="menu-logo-text">PosturEase</span>
    </div>
        <button class="menu-close" onclick="toggleMenu()">×</button>
      </div>
      
      <nav class="menu-items">
        <a href="{{ url_for('index') }}" class="menu-item active">
          <i class="fas fa-home"></i>
          <span>Home</span>
        </a>
        <a href="{{ url_for('profile') }}" class="menu-item">
          <i class="fas fa-user"></i>
          <span>View Profile</span>
        </a>
        <a href="{{ url_for('exercises') }}" class="menu-item">
          <i class="fas fa-dumbbell"></i>
          <span>Stretching & Exercises</span>
        </a>
        <a href="{{ url_for('posture_history') }}" class="menu-item">
          <i class="fas fa-history"></i>
          <span>Posture History</span>
        </a>
        <a href="{{ url_for('settings') }}" class="menu-item">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </a>
        <a href="{{ url_for('logout') }}" class="menu-item" style="color: var(--error);">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </a>
      </nav>
    </div>
  </div>


  <script>
    // Global variables for posture monitoring
    let isMonitoring = false;
    let poseNet = null;
    let canvas, ctx;
    let monitoringStats = {
      startTime: null,
      goodPostureTime: 0,
      badPostureTime: 0,
      warningsCount: 0,
      lastGoodPostureTime: null,
      lastBadPostureTime: null,
      postureTransitions: 0, // Track bad->good transitions
      lastPostureQuality: null
    };

    // Get user data from localStorage
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    
    // Update user name and profile picture in the header
    document.addEventListener('DOMContentLoaded', function() {
      loadUserProfile();
      loadCameraSettings();
      
    });

    function loadCameraSettings() {
      // Load camera settings from server
      fetch('/get-camera-settings')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Store camera settings in localStorage for quick access
            localStorage.setItem('cameraMirror', data.mirror_enabled);
            console.log('Camera settings loaded:', data);
          }
        })
        .catch(error => {
          console.error('Error loading camera settings:', error);
          // Use default settings if server request fails
          localStorage.setItem('cameraMirror', 'true');
        });
    }

    

    function loadUserProfile() {
      // Get user data from localStorage first
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
      
      // Update profile section with cached data
      if (currentUser.first_name || currentUser.last_name) {
        const fullName = `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim();
        const userNameElement = document.getElementById('dashboard-user-name');
        if (userNameElement) {
          userNameElement.textContent = fullName;
        }
        
        if (currentUser.profile_picture) {
          const profilePicElement = document.getElementById('dashboard-profile-picture');
          if (profilePicElement) {
            profilePicElement.src = currentUser.profile_picture;
          }
        }
      }
      
      // Fetch latest user data from server
      fetch('/get-user-data')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const user = data.user;
            // Update localStorage with latest data
            localStorage.setItem('currentUser', JSON.stringify(user));
            
            // Update profile information
            const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim();
            const userNameElement = document.getElementById('dashboard-user-name');
            if (userNameElement) {
              userNameElement.textContent = fullName;
            }
            
            // Update profile picture if available
            if (user.profile_picture) {
              const profilePicElement = document.getElementById('dashboard-profile-picture');
              if (profilePicElement) {
                profilePicElement.src = user.profile_picture;
              }
            }
          } else {
            console.error('Failed to fetch user data:', data.message);
          }
        })
        .catch(error => {
          console.error('Error fetching user data:', error);
        });
    }

    // Check authentication and initialize
    window.onload = function() {
      if (localStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = "{{ url_for('login') }}";
        return;
      }

      // Initialize button states
      updateButtonStates();

      // Add click event listeners for menu overlay to close on background click
      const menuOverlayEl = document.getElementById('menuOverlay');
      if (menuOverlayEl) {
        menuOverlayEl.addEventListener('click', toggleMenu);
      }
    }

    async function initializeCamera() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: 800, 
            height: 500,
            facingMode: 'user'
          } 
        });
        video.srcObject = stream;
        
        // Set up canvas
        canvas.width = 800;
        canvas.height = 500;
        ctx = canvas.getContext('2d');
        
        console.log("Camera initialized successfully");
      } catch (error) {
        console.error("Camera access denied or unavailable", error);
        showErrorModal("Camera access is required for posture monitoring. Please allow camera access and refresh the page.");
      }
    }

    async function initializePoseDetection() {
      try {
        console.log("Loading PoseNet model...");
        poseNet = await posenet.load({
          architecture: 'MobileNetV1',
          outputStride: 16,
          inputResolution: { width: 640, height: 480 },
          multiplier: 0.75
        });
        console.log("PoseNet model loaded successfully");
      } catch (error) {
        console.error("Failed to load PoseNet model:", error);
      }
    }

    async function togglePostureMonitoring() {
      const button = document.getElementById('monitoringButton');
      const status = document.getElementById('postureStatus');
      const stats = document.getElementById('monitoringStats');

      if (!isMonitoring) {
        if (!poseNet) {
          showWarningModal("Pose detection model is still loading. Please wait a moment and try again.");
          return;
        }
        
        // Start monitoring
        isMonitoring = true;
        button.innerHTML = '<i class="fas fa-stop"></i> Stop Monitoring';
        button.classList.add('monitoring');
        status.style.display = 'flex';
        stats.style.display = 'flex';
        
        // Reset stats
        monitoringStats.startTime = Date.now();
        monitoringStats.goodPostureTime = 0;
        monitoringStats.badPostureTime = 0;
        monitoringStats.warningsCount = 0;
        monitoringStats.lastGoodPostureTime = Date.now();
        monitoringStats.lastBadPostureTime = null;
        monitoringStats.postureTransitions = 0;
        monitoringStats.lastPostureQuality = null;
        
        startPostureDetection();
        updateStatsDisplay();
        
        console.log("Posture monitoring started");
      } else {
        // Stop monitoring
        isMonitoring = false;
        button.innerHTML = '<i class="fas fa-play"></i> Start Posture Monitoring';
        button.classList.remove('monitoring');
        status.style.display = 'none';
        stats.style.display = 'none';
        
        // Clear canvas
        if (ctx) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        console.log("Posture monitoring stopped");
      }
    }

    async function startPostureDetection() {
      const video = document.getElementById('video');
      
      async function detectPose() {
        if (!isMonitoring || !poseNet || !video.videoWidth) {
          if (isMonitoring) {
            requestAnimationFrame(detectPose);
          }
          return;
        }

        try {
          const pose = await poseNet.estimateSinglePose(video, {
            flipHorizontal: false,
            decodingMethod: 'single-person'
          });

          drawPose(pose);
          analyzePosture(pose);
          updateStatsDisplay();

        } catch (error) {
          console.error("Error in pose detection:", error);
        }

        if (isMonitoring) {
          requestAnimationFrame(detectPose);
        }
      }

      detectPose();
    }

    function drawPose(pose) {
      if (!ctx) return;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw keypoints
      pose.keypoints.forEach(keypoint => {
        if (keypoint.score > 0.3) {
          ctx.beginPath();
          ctx.arc(keypoint.position.x, keypoint.position.y, 5, 0, 2 * Math.PI);
          ctx.fillStyle = '#007AFF';
          ctx.fill();
        }
      });

      // Draw skeleton
      const adjacentKeyPoints = posenet.getAdjacentKeyPoints(pose.keypoints, 0.3);
      adjacentKeyPoints.forEach(keypoints => {
        ctx.beginPath();
        ctx.moveTo(keypoints[0].position.x, keypoints[0].position.y);
        ctx.lineTo(keypoints[1].position.x, keypoints[1].position.y);
        ctx.strokeStyle = '#007AFF';
        ctx.lineWidth = 2;
        ctx.stroke();
      });
    }

    function analyzePosture(pose) {
      const keypoints = pose.keypoints;
      
      // Get key points for posture analysis
      const nose = keypoints.find(kp => kp.part === 'nose');
      const leftShoulder = keypoints.find(kp => kp.part === 'leftShoulder');
      const rightShoulder = keypoints.find(kp => kp.part === 'rightShoulder');
      const leftEar = keypoints.find(kp => kp.part === 'leftEar');
      const rightEar = keypoints.find(kp => kp.part === 'rightEar');

      if (!nose || !leftShoulder || !rightShoulder || 
          nose.score < 0.5 || leftShoulder.score < 0.5 || rightShoulder.score < 0.5) {
        updatePostureStatus('warning', 'Position yourself in front of the camera');
        return;
      }

      // Calculate shoulder alignment
      const shoulderYDiff = Math.abs(leftShoulder.position.y - rightShoulder.position.y);
      const shoulderMidY = (leftShoulder.position.y + rightShoulder.position.y) / 2;
      
      // Calculate head-shoulder alignment
      const headShoulderOffset = Math.abs(nose.position.y - shoulderMidY);
      
      // Determine posture quality
      let postureQuality = 'good';
      let message = 'Excellent posture!';
      
      if (shoulderYDiff > 30) {
        postureQuality = 'warning';
        message = 'Keep your shoulders level';
        monitoringStats.warningsCount++;
      } else if (headShoulderOffset > 80) {
        postureQuality = 'bad';
        message = 'Straighten your neck and back';
        monitoringStats.warningsCount++;
      } else if (headShoulderOffset > 50) {
        postureQuality = 'warning';
        message = 'Slightly forward head posture';
        monitoringStats.warningsCount++;
      }
      
      // Update posture time tracking
      const now = Date.now();
      
      // Debug posture change
      console.log('Posture Change:', {
        quality: postureQuality,
        lastGood: monitoringStats.lastGoodPostureTime,
        lastBad: monitoringStats.lastBadPostureTime,
        currentTime: now
      });
      
      // If we were previously tracking good posture, add that time
      if (monitoringStats.lastGoodPostureTime && postureQuality !== 'good') {
        const timeToAdd = now - monitoringStats.lastGoodPostureTime;
        monitoringStats.goodPostureTime += timeToAdd;
        console.log('Added to good posture:', timeToAdd, 'ms');
        monitoringStats.lastGoodPostureTime = null;
      }
      
      // If we were previously tracking bad posture, add that time
      if (monitoringStats.lastBadPostureTime && postureQuality === 'good') {
        const timeToAdd = now - monitoringStats.lastBadPostureTime;
        monitoringStats.badPostureTime += timeToAdd;
        console.log('Added to bad posture:', timeToAdd, 'ms');
        monitoringStats.lastBadPostureTime = null;
      }
      
      // Start tracking current posture type
      if (postureQuality === 'good') {
        if (!monitoringStats.lastGoodPostureTime) {
          monitoringStats.lastGoodPostureTime = now;
          console.log('Started tracking good posture');
        }
      } else {
        if (!monitoringStats.lastBadPostureTime) {
          monitoringStats.lastBadPostureTime = now;
          console.log('Started tracking bad posture');
        }
      }
      
      updatePostureStatus(postureQuality, message);
    }

    function updatePostureStatus(quality, message) {
      const statusIndicator = document.querySelector('.status-indicator');
      const text = document.getElementById('statusText');
      
      if (statusIndicator && text) {
        // Remove any existing dot
        const existingDot = statusIndicator.querySelector('.status-dot');
        if (existingDot) {
          existingDot.remove();
        }
        
        if (isMonitoring) {
          // Create and add colored dot when monitoring
          const dot = document.createElement('div');
          dot.className = 'status-dot ' + quality;
          dot.id = 'statusDot';
          statusIndicator.insertBefore(dot, text);
          
          // Update text based on posture quality
          if (quality === 'good') {
            text.textContent = 'GOOD POSTURE';
            text.style.color = '#10B981';
            text.style.fontWeight = 'bold';
          } else if (quality === 'warning') {
            text.textContent = 'POSTURE WARNING';
            text.style.color = '#F59E0B';
            text.style.fontWeight = 'bold';
          } else if (quality === 'bad') {
            text.textContent = 'BAD POSTURE';
            text.style.color = '#EF4444';
            text.style.fontWeight = 'bold';
          }
        } else {
          text.textContent = 'Ready to monitor';
        }
      }
    }

    function updateStatsDisplay() {
      if (!monitoringStats.startTime) return;
      
      const now = Date.now();
      const sessionTimeSeconds = Math.floor((now - monitoringStats.startTime) / 1000);
      const goodPostureSeconds = Math.floor(monitoringStats.goodPostureTime / 1000);
      const badPostureSeconds = Math.floor(monitoringStats.badPostureTime / 1000);
      
      // Update modern UI elements
      const sessionTimeEl = document.getElementById('sessionTime');
      const goodPostureTimeEl = document.getElementById('goodPostureTime');
      const warningsCountEl = document.getElementById('warningsCount');
      const correctionsCountEl = document.getElementById('correctionsCount');
      
      if (sessionTimeEl) sessionTimeEl.textContent = `${sessionTimeSeconds}s`;
      if (goodPostureTimeEl) goodPostureTimeEl.textContent = `${goodPostureSeconds}s`;
      if (warningsCountEl) warningsCountEl.textContent = monitoringStats.warningsCount;
      if (correctionsCountEl) correctionsCountEl.textContent = monitoringStats.postureTransitions || 0;
    }

    function takePhoto() {
      console.log("Shutter clicked — photo capture simulated.");
    }

    function toggleMenu() {
      const menuOverlay = document.getElementById('menuOverlay');
      const sideMenu = document.getElementById('sideMenu');
      const menuIcon = document.querySelector('.menu-icon');
      if (menuOverlay) menuOverlay.classList.toggle('active');
      sideMenu.classList.toggle('active');
      if (menuIcon) menuIcon.classList.toggle('active');
    }

    function logout() {
      // Show confirmation dialog
      if (confirm('Are you sure you want to logout?')) {
        // Clear login state
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('username');
        // Redirect to login page
        window.location.href = "{{ url_for('login') }}";
      }
    }

    // Close menu when clicking outside (guard for missing elements)
    document.addEventListener('click', (e) => {
      const sideMenu = document.getElementById('sideMenu');
      const menuButton = document.querySelector('.menu, .menu-btn');
      const menuOverlay = document.getElementById('menuOverlay');
      if (!sideMenu) return;
      const clickOutsideMenu = !sideMenu.contains(e.target);
      const clickOutsideButton = !(menuButton && menuButton.contains(e.target));
      if (clickOutsideMenu && clickOutsideButton) {
        sideMenu.classList.remove('active');
        if (menuOverlay) menuOverlay.classList.remove('active');
      }
    });

    // Debug: Log when page loads
    console.log('Dashboard page loaded');
    console.log('isMonitoring variable:', typeof isMonitoring);
    console.log('monitoringStats variable:', typeof monitoringStats);
    
    // Reset monitoring state to ensure clean start
    isMonitoring = false;
    monitoringStats = {
      startTime: null,
      goodPostureTime: 0,
      badPostureTime: 0,
      lastGoodPostureTime: null,
      lastBadPostureTime: null,
      warningsCount: 0,
      actualCorrections: 0
    };
    console.log('Monitoring state reset to clean start');

    function startMonitoring() {
      console.log('startMonitoring called, isMonitoring:', isMonitoring);
      if (!isMonitoring) {
        console.log('Starting monitoring...');
        
        // Update UI elements
        const videoFeed = document.querySelector('.video-feed');
        const statusBadge = document.getElementById('statusBadge');
        const statusText = document.getElementById('statusText');
        
        if (videoFeed) videoFeed.style.display = 'block';
        if (statusBadge) statusBadge.textContent = 'Monitoring Active';
        if (statusText) statusText.textContent = 'Monitoring your posture...';
        
        isMonitoring = true;
        
        // Initialize monitoring stats
        monitoringStats = {
          startTime: Date.now(),
          goodPostureTime: 0,
          badPostureTime: 0,
          lastGoodPostureTime: null,
          lastBadPostureTime: null,
          warningsCount: 0,
          postureTransitions: 0,
          lastPostureQuality: null
        };
        
        console.log('Monitoring stats initialized:', monitoringStats);
        
        // Begin polling backend for posture
        startPosturePolling();
        console.log('Posture monitoring started');
        
        // Update button states
        updateButtonStates();
        
        console.log('Monitoring started successfully');
      } else {
        console.log('Monitoring already active');
      }
    }

    function simulatePostureMonitoring() {
      // Simulate posture changes every 3 seconds
      monitoringStats.simulationInterval = setInterval(() => {
        if (isMonitoring) {
          // Random posture quality for demo
          const qualities = ['good', 'warning', 'bad'];
          const randomQuality = qualities[Math.floor(Math.random() * qualities.length)];
          
          // Generate realistic confidence based on posture quality
          let confidence;
          if (randomQuality === 'good') {
            confidence = 0.85 + Math.random() * 0.15; // 85-100%
          } else if (randomQuality === 'warning') {
            confidence = 0.60 + Math.random() * 0.25; // 60-85%
          } else {
            confidence = 0.30 + Math.random() * 0.30; // 30-60%
          }
          
          updateMonitoringStats({
            posture_quality: randomQuality,
            confidence: confidence,
            timestamp: Date.now()
          });
        }
      }, 3000);
      
      // Check for AI posture alarms every 2 seconds
      monitoringStats.aiAlarmInterval = setInterval(() => {
        if (isMonitoring) {
          checkAIPostureAlarm();
        }
      }, 2000);
    }

    function stopMonitoring() {
      console.log('stopMonitoring function called');
      console.log('Current isMonitoring state:', isMonitoring);
      
      if (isMonitoring) {
        console.log('Stopping monitoring...');
        
        // Update UI elements
        const videoFeed = document.querySelector('.video-feed');
        const statusBadge = document.getElementById('statusBadge');
        const statusText = document.getElementById('statusText');
        
        if (videoFeed) videoFeed.style.display = 'none';
        if (statusBadge) statusBadge.textContent = 'Monitoring Stopped';
        if (statusText) statusText.textContent = 'Ready to monitor';
        
        isMonitoring = false;
        
        // Stop polling
        stopPosturePolling();
        
        // Stop AI alarm checking
        if (monitoringStats.aiAlarmInterval) {
          clearInterval(monitoringStats.aiAlarmInterval);
          console.log('AI alarm interval cleared');
        }
        
        // Update button states
        updateButtonStates();
        
        // Save monitoring session data
        console.log('Calling saveMonitoringSession...');
        saveMonitoringSession();
        
        console.log('Monitoring stopped successfully');
      } else {
        console.log('Monitoring was not active, nothing to stop');
      }
    }

    function updateButtonStates() {
      const startBtn = document.querySelector('.btn-start');
      const stopBtn = document.querySelector('.btn-stop');
      
      if (isMonitoring) {
        if (startBtn) startBtn.style.display = 'none';
        if (stopBtn) stopBtn.style.display = 'flex';
      } else {
        if (startBtn) startBtn.style.display = 'flex';
        if (stopBtn) stopBtn.style.display = 'none';
      }
    }

    

    function updateMonitoringStats(postureData) {
      if (!monitoringStats.startTime) return;
      
      const now = Date.now();
      
      // Track posture transitions for correction counting
      if (monitoringStats.lastPostureQuality && 
          monitoringStats.lastPostureQuality === 'bad' && 
          postureData.posture_quality === 'good') {
        monitoringStats.postureTransitions++;
      }
      
      // Handle posture changes - add accumulated time before switching
      if (monitoringStats.lastPostureQuality !== postureData.posture_quality) {
        // If we were tracking good posture and now it's bad, add the good time
        if (monitoringStats.lastGoodPostureTime && postureData.posture_quality !== 'good') {
          monitoringStats.goodPostureTime += now - monitoringStats.lastGoodPostureTime;
          monitoringStats.lastGoodPostureTime = null;
        }
        
        // If we were tracking bad posture and now it's good, add the bad time
        if (monitoringStats.lastBadPostureTime && postureData.posture_quality === 'good') {
          monitoringStats.badPostureTime += now - monitoringStats.lastBadPostureTime;
          monitoringStats.lastBadPostureTime = null;
        }
      }
      
      // Start tracking current posture type
      if (postureData.posture_quality === 'good') {
        if (!monitoringStats.lastGoodPostureTime) {
          monitoringStats.lastGoodPostureTime = now;
        }
      } else {
        if (!monitoringStats.lastBadPostureTime) {
          monitoringStats.lastBadPostureTime = now;
        }
        
        if (postureData.posture_quality === 'bad') {
          monitoringStats.warningsCount++;
          // Play alarm sound for bad posture
          playPostureAlarm();
        }
      }
      
      // Update last posture quality for transition tracking
      monitoringStats.lastPostureQuality = postureData.posture_quality;
      
      // Update visual status indicator
      updatePostureStatusIndicator(postureData.posture_quality);
      
      // Update confidence indicator
      updateConfidenceIndicator(postureData);
      
      // Update display
      updateStatsDisplay();
    }

    function updateConfidenceIndicator(postureData) {
      const confidenceEl = document.getElementById('confidenceIndicator');
      if (!confidenceEl) return;
      
      if (postureData && postureData.confidence !== undefined) {
        const confidence = Math.round(postureData.confidence * 100);
        confidenceEl.textContent = `Confidence: ${confidence}%`;
        
        // Color code based on confidence level
        if (confidence >= 80) {
          confidenceEl.style.background = 'rgba(16, 185, 129, 0.9)';
        } else if (confidence >= 60) {
          confidenceEl.style.background = 'rgba(245, 158, 11, 0.9)';
        } else {
          confidenceEl.style.background = 'rgba(239, 68, 68, 0.9)';
        }
      } else {
        confidenceEl.textContent = 'Confidence: 0%';
        confidenceEl.style.background = 'rgba(0, 0, 0, 0.8)';
      }
    }
    
    function playPostureAlarm() {
      // Respect user's Audio Cues setting
      const audioPref = localStorage.getItem('audioCuesEnabled');
      const audioEnabled = (audioPref === null) ? true : (audioPref === 'true');
      if (!audioEnabled) {
        return;
      }
      try {
        // Create audio context for beep sound
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        // Configure the beep sound
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // 800Hz beep
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime); // Volume level
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        // Play the beep for 0.5 seconds
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
        
        console.log('Posture alarm played - Bad posture detected!');
      } catch (error) {
        console.log('Could not play posture alarm:', error);
        // Fallback: try to play a simple beep using HTML5 Audio
        try {
          const beep = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
          beep.volume = 0.3;
          beep.play();
        } catch (fallbackError) {
          console.log('Fallback alarm also failed:', fallbackError);
        }
      }
    }
    
    function checkAIPostureAlarm() {
      // Check if AI detected bad posture and should trigger alarm
      fetch('/check-posture-alarm')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.alarm_triggered) {
            console.log('AI detected bad posture:', data.message);
            // Play alarm when AI detects bad posture
            playPostureAlarm();
            // Update status indicator to show bad posture
            updatePostureStatusIndicator('bad');
          }
        })
        .catch(error => {
          console.error('Error checking AI posture alarm:', error);
        });
    }

    function updatePostureStatusIndicator(quality) {
      let statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      const statusConfidence = document.getElementById('statusConfidence');
      
      if (statusText) {
        // Ensure a dot exists so class colors can apply
        if (!statusDot) {
          const container = document.querySelector('.status-indicator');
          if (container) {
            statusDot = document.createElement('div');
            statusDot.className = 'status-dot';
            statusDot.id = 'statusDot';
            container.insertBefore(statusDot, statusText);
          }
        }
        // Remove all quality classes
        if (statusDot) statusDot.classList.remove('good', 'warning', 'bad', 'unknown');
        
        // Add appropriate class and text
        if (statusDot) statusDot.classList.add(quality);
        
        switch(quality) {
          case 'good':
            statusText.textContent = 'Good Posture';
            statusText.style.color = '#10B981';
            statusText.style.fontWeight = 'bold';
            break;
          case 'warning':
            statusText.textContent = 'Warning';
            statusText.style.color = '#F59E0B';
            statusText.style.fontWeight = 'bold';
            break;
          case 'bad':
            statusText.textContent = 'Poor Posture';
            statusText.style.color = '#EF4444';
            statusText.style.fontWeight = 'bold';
            break;
          case 'unknown':
            statusText.textContent = 'Position yourself in front of camera';
            statusText.style.color = 'var(--text-primary)';
            statusText.style.fontWeight = '500';
            break;
        }
        if (statusConfidence) {
          // Keep previous confidence percentage until refreshed by polling
        }
      }
    }

    // Poll backend for latest posture every 1s while monitoring
    let posturePollInterval = null;
    function startPosturePolling() {
      if (posturePollInterval) return;
      posturePollInterval = setInterval(async () => {
        try {
          const res = await fetch('/get-current-posture');
          const data = await res.json();
          if (data && data.success && data.posture_data) {
            const q = data.posture_data.posture_quality;
            const conf = data.posture_data.confidence;
            
            // Update visual indicator
            updatePostureStatusIndicator(q);
            const statusConfidence = document.getElementById('statusConfidence');
            if (statusConfidence && typeof conf === 'number') {
              statusConfidence.textContent = `(${(conf*100).toFixed(1)}%)`;
            }
            
            // CRITICAL: Update monitoring stats for time tracking
            updateMonitoringStats({
              posture_quality: q,
              confidence: conf,
              timestamp: Date.now()
            });
            
            // Update stats display
            updateStatsDisplay();
          }
        } catch (e) {
          // silent fail
        }
      }, 1000);
    }

    function stopPosturePolling() {
      if (posturePollInterval) {
        clearInterval(posturePollInterval);
        posturePollInterval = null;
      }
    }

    function saveMonitoringSession() {
      console.log('saveMonitoringSession called');
      console.log('monitoringStats:', monitoringStats);
      
      if (!monitoringStats.startTime) {
        console.log('No start time, returning');
        return;
      }
      
      // Finalize any remaining tracking time
      const now = Date.now();
      if (monitoringStats.lastGoodPostureTime) {
        monitoringStats.goodPostureTime += now - monitoringStats.lastGoodPostureTime;
        monitoringStats.lastGoodPostureTime = null;
      }
      if (monitoringStats.lastBadPostureTime) {
        monitoringStats.badPostureTime += now - monitoringStats.lastBadPostureTime;
        monitoringStats.lastBadPostureTime = null;
      }
      
      const sessionDuration = Math.floor((Date.now() - monitoringStats.startTime) / 1000);
      const goodTime = Math.floor(monitoringStats.goodPostureTime / 1000);
      const badTime = Math.floor(monitoringStats.badPostureTime / 1000);
      const confidenceScore = sessionDuration > 0 ? goodTime / sessionDuration : 0;
      
      console.log('=== SESSION SAVE DEBUG ===');
      console.log('Session duration:', sessionDuration, 'seconds');
      console.log('Good posture time:', goodTime, 'seconds');
      console.log('Bad posture time:', badTime, 'seconds');
      console.log('Total tracked time:', goodTime + badTime, 'seconds');
      console.log('Confidence score:', confidenceScore);
      console.log('Raw monitoringStats:', monitoringStats);
      
      // Determine posture type based on good vs bad time comparison
      let postureType = 'Poor Posture';
      const timeDifference = Math.abs(goodTime - badTime);
      
      if (goodTime > badTime) {
        if (timeDifference <= 5) {
          postureType = 'Fair Posture';
        } else {
          postureType = 'Good Posture';
        }
      } else if (badTime > goodTime) {
        if (timeDifference <= 5) {
          postureType = 'Fair Posture';
        } else {
          postureType = 'Poor Posture';
        }
      } else {
        // Equal times
        postureType = 'Fair Posture';
      }
      
      // Calculate actual corrections based on posture transitions
      // A correction is when user transitions from bad to good posture
      const actualCorrections = monitoringStats.postureTransitions;
      
      const sessionData = {
        posture_type: postureType,
        confidence_score: confidenceScore,
        session_duration: sessionDuration,
        corrections_count: actualCorrections,
        good_time: goodTime,
        bad_time: badTime
      };
      
      console.log('Session data to send:', sessionData);
      
      // Send data to server
      console.log('Sending fetch request to /save-monitoring-session');
      fetch('/save-monitoring-session', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(sessionData)
      })
      .then(response => {
        console.log('Response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Response data:', data);
        if (data.success) {
          console.log('Monitoring session saved successfully');
          // Reset monitoring stats
          monitoringStats = {
            startTime: null,
            goodPostureTime: 0,
            badPostureTime: 0,
            lastGoodPostureTime: null,
            lastBadPostureTime: null,
            warningsCount: 0,
            postureTransitions: 0,
            lastPostureQuality: null
          };
        } else {
          console.error('Failed to save monitoring session:', data.message);
        }
      })
      .catch(error => {
        console.error('Error saving monitoring session:', error);
      });
    }


  </script>

</body>
</html>
 